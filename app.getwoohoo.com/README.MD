# Общие сведения

Здесь можно посмотреть детально, что делал проект и как выглядел, когда я работал над ним. 
В тексте исправляются ошибки, дополняются разделы.

### Термины

"Игра" - всплывающая форма, вариант [виджета](#принцип-работы-виджета), который позволяет получить
купон на скидку в магазине.

Коммит - снимок состояния файлов проекта. Список файлов и изменений, которые были внесены автором.

# Разработка

### Список разработчиков
- Я - 3730 коммитов.
- 716 коммитов - Лиран.
- 141 коммит - Вадим.
- 100 коммитов - Хасмик.
- 77 коммитов - Мехул.
- 51 коммит - Владислав.
- 9 коммитов - Адир.
- 8 коммитов - Сона.
- 6 коммитов - Сергей.

### Хронология

Проект разрабатывался с апреля 2017 и единственным программистом был я до 2019. В первой доступной
версии приложения был ровно один вариант виджета с "игрой", минимальная интеграция установки приложения
Shopify, генерация статичных купонов(в том числе для Shopify) и поддержка отправки купона по почте
через SendGrid API. Я добавлял новые API и расширял старые: Shopify, Mailchimp, Klaviyo,
Omnisend, Isracard, Fingerprint, IP-API, Cloudflare, TheChecker, ChatChamp. В этот период сервера были
разделены сначала на два разных(MySQL, php), потом на четыре(MySQL, php, LoadBalancer, Redis) - масштабирование
проекта для клиента с посещением 2 млн. уникальных пользователей в месяц. Reids сервер использовался для
хранения данных аутентификации. В последствии Redis сервер начал использоваться как кеширующий и брокер очередей.

С июня по ноябрь 2019 я был занят разработкой couponzone.app.

C декабря 2019 по август 2020 я был занят разработкой hype.getwoohoo.com.

С 2019 года по 2022 владелец нанимал программистов. Одновременно в этот период работало не больше двух
программистов - я и один из списка - Влад, Михул, Сергей, Вадим, Сона или ещё пара программистов/верстальщиков.
В периоды между уходом/приходом разработчика, могло пройти какое-то время, и я был одним программистом на проекте.

С 2020 года по 2025 на повестке были большие задачи, между которыми меня перекидывали
на оптимизацию виджета на frontend, на новые фичи, на исправления багов, в том числе большого скачка
в активности пользователей в конце 2022 из-за чего за месяц перед новым 2023 годом приложение
было в состоянии когда оно плохо работает, падает на некоторых запросах. В течении полугода
я занимался профилированием Mysql, очисткой лишнего в redis, кешированием частотных запросов,
закрытием части тех долга, изменением части логики в связи с переездом на CDN.

Одна из двух больших задач - новый редактор - исследовательская для меня. Вторая задача - это новый
функционал для пользовательского интерфейса в виде фильтрации статистики по сайтам, "играм", дням.
Сложность этой задачи заключалась в том, что статистика накопленная в mysql для страниц личного кабинета
составляла 500 миллионов записей. Количество отправленных пользовательских данных больше 50 миллионов записей.

### Детали

В разное время количество одновременно работающих человек над проектом, известных мне, было от трёх до шести.

Количество коммитов сделанных мной 4483, из них для этого проекта - 3730. Количество отработанного времени
в этом проекте за 8 лет 3 месяца - 11 953 часов(TopTal трекер), 1549 закрытых тикета на Bitbucket для трёх проектов.

Вклад остальных людей работавших над проектом - 1173 коммита.

Владелец - Лиран, в прошлом верстальщик. Добавил 716 коммитов за время проекта с
учётом версии лендинга в основном репозитории. Над лендингами работал Лиран, позже
версия в репозитории была заменена на другой. Моя вёрстка в приложении работала,
но Лиран мог делать вёрстку привлекательнее. Лиран правил в вёрстке какие-то
крайние случаи с отдельными устройствами или браузерами.

Все коммуникации не технического характера, договор, общение, решение финансовых вопросов
с владельцем осуществлял Олег. Олег - мой товарищ по университету, мы учились вместе
в СевКавГТУ(СКФУ сейчас) 5 лет, с 2007 по 2012 год. Он позвал меня работать
вместе с ним в 2016 году. В 2016 был совсем другой проект, который ниже описан не будет.

Следующий по количеству коммитов - программист Вадим, который в репозитории оставил 141 коммит.
Большая часть из них не попала в прод. Обновления версий ПО: Laravel, Vue, php, Mysql - Лиран
по какой-то причине не одобрил. Его работа, которая попала в прод, заключалась в интеграции Jilt
API. Лиран решил отключить эту интеграцию. Была ещё работа связанная с интеграцией Shopify, но
она была не закончена.

Сергей делал интеграцию с ZappierApp, ActiveCampaign.

Владислав сделал функционал расширенного триального периода для пользователя, т.к. некоторым
пользователям не хватало стандартного. Владислав не успел начать заниматься новым
приложением - couponzone.app, владелец с ним расстался. На этот проект Лиран назначил меня.

Мехул сделал один из вариантов кнопки открытия виджета и один вариант "игры"(fullwheel) в виджете.
Мехул занимался внедрением оплаты в hype.getwoohoo.com.

Хасмик сделала интеграцию с CampaignMonitor. Из того что не попало в прод была небольшая задачка
в админке, из-за "тяжёлого" запроса. И проваленная задача по добавлению фильтров на страницы
со статистикой.

Адир - друг владельца, который модифицировал вёрстку шаблона виджета через Bitbucket.

Был один из программистов, который сделал конфетти. Они выбрасывались в конце "игры" на финальном экране.
<details>
  <summary>Конфетти</summary>
  <img src="images/confetti.png" width="250" alt="конфетти" />
</details>

# Приложение

Сайт представляет собой SPA приложение с использованием фреймворков Laravel 5.4, Vue 2.
Приложение - это виджет, который встраивается в клиентский сайт, магазин. В зависимости от пользователя,
Shopify пользователь или общий пользователь, встраивание происходит через API или вручную, пользователем,
владельцем магазина.

<details>
    <summary>Панель управления</summary>
    <img src="images/dashboard.png" width="450" alt="Панель управления" />
</details>

Данные, которые собирает виджет, отображается на панели управления. Количество
просмотров, отправленные данные почты пользователей и сгенерированных купонов для пользователей
клиентского сайта.

<details>
    <summary>страница Subscribers</summary>
    <img src="images/subscribers.png" alt="страница Subscribers" width="350" />
    <img src="images/revenue.png" alt="страница Revenue" width="350" />
</details>

### Структура

Страницы:
- список созданных кампаний;
- список сайтов;
- аккаунт;
- интеграции;
- выбор виджета;
- редактор виджета;
- аффилированные пользователи;
- логин/регистрация пользователя;
- статистика показов/собранных данных;
- выбора плана.

Административные страницы:
- список обычных магазинов и Shopify;
- магазины остановившие подписку;
- магазины использующие триальную версию;
- купленные планы;
- статус очередей.

Функционал:
- компонент предпросмотра виджета в приложении;
- компонент встраивания виджета на сторонний сайт;
- очереди задач;
- редактор;
- интеграции API;
- подписка на события API сервисов.

Компоненты виджета:
- кнопка запуска основного окна;
- генерации шаблона основного окна;
- обработки данных "игры";
- отдельных "игр";
- отчёта обратного времени.

### Принцип работы виджета

После действия пользователя(кнопка старт) происходит анимация случайного выбора. В действительности
логика выбора купона происходит в пару тактов процессора основываясь на псевдослучайном генераторе от 0 до 1.
Каждый вариант купона [настраивается](#редактор) со своим кодом купона(может быть пустым). Вероятность выпадения
высчитывается на основе параметра gravity, в зависимости от того какой gravity был присвоен другим купонам.
Запрос отправляется на сервер и формируется код купона в зависимости от выпавшего пользователю купона
и отправляется на указанную им почту или показывается на экране в зависимости от настроек.

<details>
    <summary>spinthewheel</summary>
    <img src="images/widget/spinthewheel.gif" alt="spinthewheel">
</details>

### Редактор

Пользователь имеет возможность изменять цвета формы, кнопок, шрифты, текст, создавать купоны, сложные настройки
условий и фильтров по которым появляется виджет, настраивать кнопку открытия виджета. Все эти данные хранятся в MySQL.
В зависимости от виджета есть разные задачи, которые запускаются фоном, для сохранения картинки
или скрипта на CDN, обновления ссылок для части магазинов. Настраиваются купоны, которые могут генерироваться
через API во время "игры" или создаваться в редакторе.

<details>
    <summary>Редактор</summary>
    <img src="images/editor/editor-settings.png" width="550" alt="настройки редактора Settings">
</details>

<details>
    <summary>Панель инструментов design</summary>
    <img src="images/editor/panel-design-1.png" height="325" alt="Панель инструментов design">&nbsp;
    <img src="images/editor/panel-design-2.png" height="325" alt="Панель инструментов design">&nbsp;
    <img src="images/editor/panel-text.png" height="325" alt="Панель инструментов text">&nbsp;
</details>

<details>
    <summary>Настройка купонов</summary>
    <img src="images/editor/coupons-list.png" height="250" alt="настройка купонов">  
    <img src="images/editor/coupons-form-1.png" height="250" alt="форма настройки Shopify купонов">&nbsp;
    <img src="images/editor/coupon-form-2.png" height="250" alt="форма настройки Shopify купонов">&nbsp;
</details>

### Варианты виджета

В разное время было доступно разное количество виджетов. На момент написания доступно три виджета:
- spinthewheel;
- reveal;
- fullwheel;

<details>
  <summary>spinthewheel, reveal, fullwheel</summary>
  <img src="images/widget/spinthewheel.png" height="200" alt="spinthewheel" />&nbsp;
  <img src="images/widget/reveal.png" height="200" alt="reveal" />&nbsp;
  <img src="images/widget/fullwheel.png" height="200" alt="fullwheel" />    
</details>

Были приостановлены:
- gift;
- coupon;
- slot;
- wheel.

Инструкция как посмотреть на [скрытые виджеты](#скрытые-виджеты) в приложении.

<details>
  <summary>coupon, gift, slot</summary>
  <img src="images/widget/hidden/coupon.png" height="200" alt="coupon" />&nbsp;
  <img src="images/widget/hidden/slot.png" height="200" alt="slot" />&nbsp;
  <img src="images/widget/hidden/gift.png" height="200" alt="gift" />
</details>

Из этих семи "игр" шесть были сделаны мной, fullwheel скопирован Мехулом на основе spinthewheel.

Прообразом spinthewheel и fullwheel был виджет с названием wheel. Поддержка виджета wheel
была приостановлена.

Мной разрабатывался ещё один из вариантов "игры", который не вышел в прод - scratch.
<details>
  <summary>scratch</summary>
  <img src="images/widget/hidden/scratch.png" height="200" alt="scratch" />    
</details>

### Frontend

Первая версия дизайна была свёрстана мной по скриншотам, пока Лиран искал дизайнера. На мне
была интеграция вёрстки с vue шаблонами, редактор, который через хуки изменял внешний вид
виджета в реальном времени. По мере готовности дизайна я перевёрстывал некоторые
элементы, а Лиран делал его привлекательнее (тени, transition). Текущий дизайн проекта - это 
вторая версия и была свёрстана отдельным верстальщиком, которого нашёл Лиран.
Моя работа заключалась в том, чтобы интегрировать во вторую версию вёрстки логику
vue и js, редактора виджета.

### Backend

На момент старта приложения я был вдохновлён идеями Роберта Мартина и мне хотелось делать
понятную, выразительную архитектуру. Самое близкое и простое архитектурное
решение - Action/Command паттерн. Паттерн в последствии дал возможность использовать
message bus архитектуру. По мере сил я следовал трём правилам: сделай что
бы работало, сделай код понятным, сделай его быстрым.

Изначально, я не предполагал, что выйдет долгая продуктовая разработка в 8 лет. Было не
понятно, сможет приложение выжить или нет. Отсутствие DDD диктовалось условиями
на предоставление быстрых результатов. Сейчас очевидно, что внедрение DDD на старте
проекта было бы проблематично, и усложнение кода хоть на немного за счёт выделения
бизнес логики замедлило бы разработку на начальном этапе. В краткосрочной
перспективе отсутствие DDD сработало отлично. На долгосрочной перспективе, быстрый
старт был скомпенсирован количеством нанятых разработчиков.

Размеры кода, количество пользователей, размер базы, росло всё. Доставлять новые фичи, и
в некоторых случаях, править возникающие ошибки стало затратнее. Небольшая часть пакетов
организованна по мотивам слоистой архитектуры. Например, в компоненте Redis можно
встретить абстрактные, концептуальные классы смешанные с конкретными реализациями:<br />
<details>
    <summary>компонент Redis</summary><br />
    <img src="images/redis_structure.png" width="250"  alt="структура"/>
</details>

Организация проекта:

<details>
    <summary>структура</summary><br />
    <img src="images/app_structure.png" width="250" alt="структура компонентов" />
</details>
<details>
    <summary>компоненты приложения</summary><br />
    <img src="images/lucky-coupon_structure.png" width="250" />
</details>
<details>
    <summary>компонент построения шаблонов</summary><br />
    <img src="images/templates_structure.png" width="250" />
</details>
<details>
    <summary>платёжный компонент</summary><br />
    <img src="images/package_structure.png" width="250" />
</details>

В качестве примера кода из приложения я привожу компонент работы с различными API. Хотя я не считаю
его идеальным, но компонент был написан достаточно абстрактно, что бы несколько программистов смогли с ним
разобраться без документации и добавить свои интеграции.

### База данных

По-мимо общей схемы приложения, я проектировал базу данных. Не по советам Роберта Мартина,
где база - это всего лишь деталь реализации, а по советам моих преподавателей в университете,
которые говорили, что смена базы данных - это явление крайне редкое и на практике лучше строить
свою информационную систему вокруг хорошо спроектированной базы данных.

К одному из наплывов пользователей когда количество пользователей увеличилось до 1500-2000
одну таблицу статистики появилась необходимость разделить. Запуск приложения,
за счёт одной таблицы на старте, был быстрее. На момент написания текста, эти таблицы составляют
основную массу данных - 500 млн. и 50 млн. строк.

Всего в приложении 51 MySQL таблица.

### Сервера

В первых версиях работающего приложения nginx, php, mysql располагались на одном единственном сервере.
Сейчас это отдельные сервера: load balancer, php-fpm, redis, mysql, CDN. Есть возможность развернуть
множество php-fpm серверов для масштабирования обработки запросов, фоновых задач на отдельных серверах.

### Обновления ПО

PHP 5.6 было обновлено на PHP 7.2.

### Скрытые виджеты

В следствии изменений приложения некоторые виджеты были скрыты. Есть возможность их создать по ссылке:

- https://app.getwoohoo.com/#add/gift
- https://app.getwoohoo.com/#add/coupon
- https://app.getwoohoo.com/#add/slot
- https://app.getwoohoo.com/#add/wheel

Инструкция по созданию:
1. Войти на сайт app.getwoohoo.com под своим логином или авторизоваться через Shopify.
2. Ссылку выше вставить в строку браузера;
3. Нажать на Enter;
4. Нажать на кнопку "Перезагрузить страницу" (<img src="images/reload_button.png" width="15" />) в браузере.

Некоторые элементы интерфейса, неподдерживаемых виджетов, в редакторе могут не работать.

### Репозиторий

Некоторые пакеты для нового редактора можно найти у меня на [github]
- [js-class-parser] - основной пакет для dependency injection container;
- [css-vars-extractor] - экстрактор переменных из файлов стилей;
- [shadow-dom] - класс-обёртка для работы с Shadow dom;
- [html-manipulator] - обёртка по работе с преобразованием объектов в HTML элементы.

[github]: https://github.com/nonick891
[js-class-parser]: https://github.com/nonick891/js-class-parser
[css-vars-extractor]: https://github.com/nonick891/css-vars-extractor
[shadow-dom]: https://github.com/nonick891/shadow-dom
[html-manipulator]: https://github.com/nonick891/html-manipulator